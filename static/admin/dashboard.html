<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | VoiceGuardAI</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        
        .dashboard-header {
            background: linear-gradient(90deg, #4263eb 0%, #60a5fa 100%);
            color: white;
            padding: 2rem 0;
        }
        
        .stats-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #4263eb;
        }
        
        .stats-card .label {
            font-size: 1rem;
            color: #6b7280;
        }
        
        .stats-card .trend {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .trend.up {
            color: #10b981;
        }
        
        .trend.down {
            color: #ef4444;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .login-form {
            max-width: 400px;
            margin: 100px auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        #dashboard-content {
            display: none;
        }
        
        #login-container {
            display: block;
        }
        
        .nav-pills .nav-link.active {
            background-color: #4263eb;
        }
        
        .nav-pills .nav-link {
            color: #4b5563;
        }
        
        .nav-pills .nav-link.active {
            color: white;
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="login-container">
        <div class="login-form">
            <h2 class="text-center mb-4">Admin Dashboard</h2>
            <form id="login-form">
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">Login</button>
                </div>
                <div class="mt-3 text-danger text-center" id="login-error" style="display: none;">
                    Invalid username or password
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard-content" class="container-fluid py-4">
        <div class="dashboard-header mb-4">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <h1>VoiceGuardAI Admin Dashboard</h1>
                    <button id="logout-btn" class="btn btn-outline-light">Logout</button>
                </div>
            </div>
        </div>
        
        <div class="container">
            <!-- Navigation Tabs -->
            <ul class="nav nav-pills mb-4" id="dashboard-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab">Overview</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="petition-tab" data-bs-toggle="pill" data-bs-target="#petition" type="button" role="tab">Petition</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analytics-tab" data-bs-toggle="pill" data-bs-target="#analytics" type="button" role="tab">App Analytics</button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="dashboard-content-tabs">
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel">
                    <h2 class="mb-4">Dashboard Overview</h2>
                    
                    <div class="row">
                        <!-- Petition Stats -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Petition Campaign</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="stats-card text-center">
                                                <div class="number" id="overview-signatures">0</div>
                                                <div class="label">Total Signatures</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="stats-card text-center">
                                                <div class="number" id="overview-completion">0%</div>
                                                <div class="label">Goal Completion</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-grid">
                                        <a href="petition-dashboard.html" class="btn btn-outline-primary">View Petition Dashboard</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- App Stats -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">App Performance</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="stats-card text-center">
                                                <div class="number" id="overview-users">0</div>
                                                <div class="label">Total Users</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="stats-card text-center">
                                                <div class="number" id="overview-scans">0</div>
                                                <div class="label">Total Scans</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-grid">
                                        <button id="view-analytics-btn" class="btn btn-outline-success">View App Analytics</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Petition Tab -->
                <div class="tab-pane fade" id="petition" role="tabpanel">
                    <iframe src="petition-dashboard.html" style="width: 100%; height: 800px; border: none;"></iframe>
                </div>
                
                <!-- Analytics Tab -->
                <div class="tab-pane fade" id="analytics" role="tabpanel">
                    <h2 class="mb-4">App Analytics</h2>
                    
                    <div class="row">
                        <!-- User Stats -->
                        <div class="col-md-3 mb-4">
                            <div class="stats-card text-center">
                                <div class="number" id="total-users">0</div>
                                <div class="label">Total Users</div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-4">
                            <div class="stats-card text-center">
                                <div class="number" id="premium-users">0</div>
                                <div class="label">Premium Users</div>
                                <div class="trend up" id="premium-trend"><i class="fas fa-arrow-up"></i> <span id="premium-percentage">0%</span></div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-4">
                            <div class="stats-card text-center">
                                <div class="number" id="daily-active-users">0</div>
                                <div class="label">Daily Active Users</div>
                                <div class="trend" id="dau-trend"><i class="fas fa-arrow-up"></i> <span id="dau-percentage">0%</span></div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-4">
                            <div class="stats-card text-center">
                                <div class="number" id="monthly-active-users">0</div>
                                <div class="label">Monthly Active Users</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Scan Stats -->
                        <div class="col-md-4 mb-4">
                            <div class="stats-card text-center">
                                <div class="number" id="total-scans">0</div>
                                <div class="label">Total Scans</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-4">
                            <div class="stats-card text-center">
                                <div class="number" id="ai-detection-rate">0%</div>
                                <div class="label">AI Detection Rate</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-4">
                            <div class="stats-card text-center">
                                <div class="number">$<span id="monthly-revenue">0</span></div>
                                <div class="label">Monthly Revenue</div>
                                <div class="trend up" id="revenue-trend"><i class="fas fa-arrow-up"></i> <span id="revenue-percentage">0%</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Charts -->
                        <div class="col-md-6 mb-4">
                            <div class="chart-container">
                                <h5>User Growth</h5>
                                <canvas id="user-growth-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <div class="chart-container">
                                <h5>Scan Results</h5>
                                <canvas id="scan-results-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <div class="chart-container">
                                <h5>Daily Active Users</h5>
                                <canvas id="dau-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        // Admin credentials (in a real app, this would be handled server-side)
        // IMPORTANT: If you change these credentials, make sure to update them in the backend API (petition_handler.py) as well
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'voiceguard2025';
        
        $(document).ready(function() {
            // Handle login form submission
            $('#login-form').on('submit', function(e) {
                e.preventDefault();
                
                const username = $('#username').val();
                const password = $('#password').val();
                
                if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                    // Hide login, show dashboard
                    $('#login-container').hide();
                    $('#dashboard-content').show();
                    
                    // Load dashboard data
                    loadDashboardData();
                } else {
                    $('#login-error').show();
                }
            });
            
            // Handle logout
            $('#logout-btn').on('click', function() {
                $('#dashboard-content').hide();
                $('#login-container').show();
                $('#login-form')[0].reset();
                $('#login-error').hide();
            });
            
            // Handle analytics button click
            $('#view-analytics-btn').on('click', function() {
                $('#analytics-tab').tab('show');
            });
        });
        
        // Load dashboard data
        function loadDashboardData() {
            // Load petition data
            fetch('/api/petition/admin')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Petition API not available');
                    }
                    return response.json();
                })
                .then(data => {
                    updatePetitionStats(data);
                })
                .catch(error => {
                    console.error('Error loading petition data:', error);
                    // Show error message in the petition stats section
                    $('#overview-signatures').text('Error');
                    $('#overview-completion').text('Error');
                });
            
            // Load analytics data
            fetch('/api/analytics/dashboard')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Analytics API not available');
                    }
                    return response.json();
                })
                .then(data => {
                    updateAnalyticsStats(data);
                    createCharts(data);
                })
                .catch(error => {
                    console.error('Error loading analytics data:', error);
                    // Show error message in the analytics stats section
                    $('#overview-users').text('Error');
                    $('#overview-scans').text('Error');
                    $('#total-users').text('Error');
                    $('#premium-users').text('Error');
                    $('#daily-active-users').text('Error');
                    $('#monthly-active-users').text('Error');
                    $('#total-scans').text('Error');
                    $('#ai-detection-rate').text('Error');
                    $('#monthly-revenue').text('Error');
                    
                    // Create empty charts
                    createEmptyCharts();
                });
        }
        
        // Update petition stats
        function updatePetitionStats(data) {
            $('#overview-signatures').text(data.count.toLocaleString());
            
            const percentage = Math.min(Math.round((data.count / 50000) * 100), 100);
            $('#overview-completion').text(percentage + '%');
        }
        
        // Update analytics stats
        function updateAnalyticsStats(data) {
            // Overview tab
            $('#overview-users').text(data.total_users.toLocaleString());
            $('#overview-scans').text(data.total_scans.toLocaleString());
            
            // Analytics tab
            $('#total-users').text(data.total_users.toLocaleString());
            $('#premium-users').text(data.premium_users.toLocaleString());
            $('#daily-active-users').text(data.daily_active_users.today.toLocaleString());
            $('#monthly-active-users').text(data.monthly_active_users.toLocaleString());
            
            $('#total-scans').text(data.total_scans.toLocaleString());
            $('#ai-detection-rate').text(data.scan_results.ai_detection_rate + '%');
            $('#monthly-revenue').text(data.revenue.monthly.toLocaleString());
            
            // Update trends
            updateTrend('#premium-trend', '#premium-percentage', data.conversion_rate_change);
            updateTrend('#dau-trend', '#dau-percentage', data.daily_active_users.change_percentage);
            updateTrend('#revenue-trend', '#revenue-percentage', data.revenue.change_percentage);
        }
        
        // Update trend indicators
        function updateTrend(trendSelector, percentageSelector, changePercentage) {
            const trend = $(trendSelector);
            const percentage = $(percentageSelector);
            
            if (changePercentage > 0) {
                trend.removeClass('down').addClass('up');
                trend.html(`<i class="fas fa-arrow-up"></i> ${changePercentage}%`);
            } else if (changePercentage < 0) {
                trend.removeClass('up').addClass('down');
                trend.html(`<i class="fas fa-arrow-down"></i> ${Math.abs(changePercentage)}%`);
            } else {
                trend.removeClass('up down');
                trend.html(`0%`);
            }
        }
        
        // Create charts
        function createCharts(data) {
            // User growth chart
            const userGrowthCtx = document.getElementById('user-growth-chart').getContext('2d');
            new Chart(userGrowthCtx, {
                type: 'line',
                data: {
                    labels: data.historical.dates,
                    datasets: [{
                        label: 'Total Users',
                        data: data.historical.users,
                        borderColor: '#4263eb',
                        backgroundColor: 'rgba(66, 99, 235, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            
            // Scan results chart
            const scanResultsCtx = document.getElementById('scan-results-chart').getContext('2d');
            new Chart(scanResultsCtx, {
                type: 'doughnut',
                data: {
                    labels: ['AI Detected', 'Human Voice'],
                    datasets: [{
                        data: [data.scan_results.ai_detected, data.scan_results.human_detected],
                        backgroundColor: ['#ef4444', '#10b981']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            
            // DAU chart
            const dauCtx = document.getElementById('dau-chart').getContext('2d');
            new Chart(dauCtx, {
                type: 'bar',
                data: {
                    labels: data.historical.dates,
                    datasets: [{
                        label: 'Daily Active Users',
                        data: data.historical.dau,
                        backgroundColor: '#60a5fa'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }
        
        // Create empty charts when API data is not available
        function createEmptyCharts() {
            // Create empty user growth chart
            const userGrowthCtx = document.getElementById('user-growth-chart').getContext('2d');
            new Chart(userGrowthCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Total Users',
                        data: [],
                        borderColor: '#4263eb',
                        backgroundColor: 'rgba(66, 99, 235, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            
            // Create empty scan results chart
            const scanResultsCtx = document.getElementById('scan-results-chart').getContext('2d');
            new Chart(scanResultsCtx, {
                type: 'doughnut',
                data: {
                    labels: ['AI Detected', 'Human Voice'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#ef4444', '#10b981']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            
            // Create empty DAU chart
            const dauCtx = document.getElementById('dau-chart').getContext('2d');
            new Chart(dauCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Daily Active Users',
                        data: [],
                        backgroundColor: '#60a5fa'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
